# -*- coding: utf-8 -*-

"""
    Version 1 : 05/12/2015
    
    Version 2 : 31/07/2017
        *** Larry whishes ***
            Tour wish list:
            Gahreesen is, of course, chock full of glitches and choke points, so much of the work for Stone and Mirphak will be crowd control and warping. 
            We know that we'll have to avoid the elevator and the outside doors of Gahreesen II like the plague.

            === First week ===
                * Gahreesen I: 
                This is easy, up to a point. 
                Warp to the normal link-in room. We'll walk through the downstairs rooms normally. 
                Warp us up to the second floor next to the sniper's window and we'll walk around up there. 
                The power needs to be turned on for the doors to work.

                * Gahreesen III: 
                This is the outdoors part of the tour. 
                We'll need to warp up to the top of Gahreesen I to avoid the elevator both as a choke point and a source of glitches, 
                and that's been a difficult process in the past. 
                Hope it goes smoothly this time.

                * Once outside on the roof, 
                no further effects are needed until we go to the center spire; 
                I'd like to link there to avoid timing issues and people falling and panic linking if possible.

                * Exception #1: 
                if you can, being able to trigger the sound files of the monsters on demand would be nice. 
                In the sound effects, the files are called grsnCreature01_02.ogg, grsnCreature03_04.ogg, grsnCreature05_06.ogg, and grsnCreature07_08.ogg.

                * Exception #2: 
                Gahreesen II has retractable bridges that can be drawn in to prevent access when the fortresses are on alert. 
                When the Age was first opened by the DRC, the bridges were pulled in, preventing explorers from getting past the rock spire. 
                If you can, it would be great if you could have the bridges pulled in when we first go up to the top of Gahreesen I, and then extend them on demand. 
                If you can't, that's okay, but it's something we've never done before.

            === Second Week ===
                * Gahreesen II: 
                This is another place where we want to avoid jumping across the gap and dealing with the one-person only doors. 
                Linking to the conference room directly would be okay; we can backtrack to a mud room from there.

                * In the prison, 
                it would be nice if we can avoid wasting time searching for the two sets of bones in the outer ring corridor. 
                If you can set coordinate markers to warp us directly to both the alien and human bones, that would save us a lot of time. 
                It would also be better if we can avoid the ladders and warp to the middle-level corridor outside the control room, and then warp up to the top level. 
                While the ladders to both places are safe enough, we waste time hunting for the ladder from the prison corridors and then waiting for everyone to climb up. 
                The more time we save getting people to the next lecture locations, the more time we can save actually giving the lecture.

                * The Wall: 
                Bitter experience has shown time and again that no matter how much we say 
                "stay off the wall and don't touch the glowing buttons over under the window", someone always does what they should not. 
                If you can disable the linking buttons and place a barrier of some kind to keep them off the wall catwalks, that would be a blessing. 
                Otherwise, we'll probably end up crashing at some point during the lecture. 
                I don't know if there are any effects built into the chamber you can activate, but if there aren't any, so be it.

                * The Maintainer's Nexus: 
                This is another area we've had problems with in the past. 
                The link into the Nexus takes you to a sunken pit where an elevator raises you into the main part of the room. 
                That pit and elevator don't like crowds and tend to glitch. 
                If you can get us into the room while avoiding it, it would help avoid a frustrating experience for all of us. 
                The linking book machine there also tends to be quirky, but I have no ideas about how to deal with that.
            ===
            I'm not sure what to do about the after-tour playtime in either session. 
            In Gahreesen III, if we can set up a surface for an on-lake effect and let them explore the model around the towers, that would work. 
            But I seem to recall you both saying that you couldn't. 
            And the second week, I have no ideas at all. 
            Does anyone else?     

    Version 3 : 12/09/2020 - 10/10/2020
        ** Gahreesen # 1 : 12/09/2020 **
            So. Next tour is the first half of Gahreesen. 
            The schedule didn’t mention where we should fit Gahreesen II’s prison level, 
            but we ought to have time in the second half so we can do 
            the entire building in one tour. 
            For that one, 
            we’ll want to start on the prison level and then go down to the main floor, 
            then the Wall chamber, 
            then the Maintainer’s Nexus.

            But that’s next month. 
            This time we’re doing Gahreesen I and Gahreesen III, the outdoors.

            Gahreesen I’s interior will need the normal cat-herding tricks. 
            Once we’re done with the first floor, 
            teleport up to the second floor in the room with the sniper’s window. 
            We want the gear room to already  be running, 
            although it’d be simple to start it up since we’d have no lack of help.

            Next is the usual headache – teleporting everyone up to the roof without lots of 
            skydiving involved.

            Outside, we want to go to the rock pillar with the maintainer marker on it, 
            and set up some Jalak pillar viewing platforms in scenic spots. 
            If possible, at least one platform down near the lake surface so that Gahreesen II 
            really towers over us.

            I assume we will all have to manually jump over to the central rock spire before 
            you can warp us around? Or would it work if I jump and everyone uses “find larry”?

            I’ll have one or two still pictures to show, and some sound effects.

        ** Gahreesen # 2 : 10/10/2020 **
            Susa'n : 
                Do the “usual warps” include The Wall and the chamber the Gahreesen trainees visit after they’ve climbed The Wall?
            Larry :
                Mirphak, I’m wondering if you can set up some warp points in advance to speed moving the group around. 
                In the prison, we always end up spending a lot of time finding and moving the group to areas of interest.

                What I’d like to do is have preset points you can warp us to instead. Specifically,

                1- the two places in the lower prison level where the bones are
                2- the middle prison level next to the manhole and ladder so we don’t have to climb up
                3- the upper prison level near the center so we don’t have to climb that ladder

                Other than that, the usual warps will be fine.
            Larry :
                The tour starts in the prison cell, and moves through the rest of the prison floors. 
                Then we warp down to the main level and walk around the rooms on one side.

                It’d be nice if Mirphak could get the dressing machine to work so we could show it in operation, 
                but I’ve never asked him to. 
                We wouldn’t want to have tour guest use it anyway since it’s both a choke-point and something whose 
                reliability is unknown. 
                It might crash the game if he could turn it on.

                Something I’ve forgotten to ask up until now was to change someone’s clothing to the special sealed 
                suit used in the wall chamber. 
                That’s something I’d like to do this time around.

                We warp the group into the Wall chamber and do the bit there. 
                If Mirphak can use an invisible Jalak pillar or some other method to block off the ladder up to the wall, 
                that would be nice since all too often people give in to the temptation to climb on it even though we 
                tell them not to.

                From there, we warp to the Maintainer’s Nexus, which is where the tour ends.

                The Nexus is tricky since there’s an invisible wall around the arrival point that only gets removed if 
                you link there using the 
                link points in the wall chamber and ride the elevator platform up. 
                But that removes all your avatar’s custom clothing and appearance settings, leaving you with generic 
                default clothing and appearance. 
                The mechanism is there to remove the sealed Maintainer suit one gets by using the dressing machine to 
                enter the wall chamber. 
                Since we can’t use that, the mechanism doesn’t have anything to restore and strips the player 
                customizations instead.

                So one has to warp to an avatar or save-point that’s already in the Nexus and outside the elevator platform 
                (using the bot commands to walk through the invisible wall works) 
                to avoid triggering the mechanism that strips the avatars.
            ---------------
            - Preparation -
            ---------------
                - 1 - Arrivee a la cellule de la prison : (= !sp 19)
                    !to prison, !check noladder (mis en route a chaque link/meet), link/meet
                - 2 - Les couloirs de la prison :
                    //event 26 (phare) 
                    //ws 10 ct (1ers os) + !warpall
                    //ws 11 ct (2emes os) + !warpall
                    //ws 12 ct (echelle bas) + !warpall 
                - 3 - Niveau principal de la prison = Veranda :
                    //event 26 off
                    //ws 13 ct (echelle haut, main level) + !warpall
                    //ws 14 ct (entrance door, main level) = !sp 20 + !warpall
                    //ws 15 ct (center of the chamber, main level) + !warpall
                - 3 - Niveau haut de la prison :
                    //ws 16 ct (center, upper level) or !sp 22 + !warpall
                - 4 - Etage "entrainement" :
                    Je ne sais pas dans quel ordre Larry veut faire la visite
                    En fonction de ses choix, voir quels SpawnPoints utiliser
                    Je n'ai pas encore trouver comment faire fonctionner la machine
                    pour revetir la MaintainerSuit, mais on peut utiliser :
                        * //saveme <name>, //restoree fmaint ou mmaint, et //restoreme <name>
                    - !sp 24 : Salle d'observation sans pierre
                    - !sp 25 : Salle d'observation avec pierre
                    - !sp 26 : Salle de controle 1
                    - !sp 27 : Salle de controle 2 (ou !sp 28, ou !sp 35)
                    - //ws 17 ct : Au pied du mur
                    - //ws 18 ct : un des wall nexus (prenons !sp 30 + //walk) + //event 26

    Version 4 : 27/01/2024
        ** Gahreesen # 1 : 27/01/2024 **
            Larry F lun. 22/01/2024 21:47 to Zeke, Susan, moi, Guild

            Yep. 
            Earlier this month r'Tay and I went over the script to try to make sure it's current.

            Necessary effects...

            Once we all link to the Age, the first thing needed will be to warp us over the chasm in the floor on the way to the KI dispenser.
            After we're done with the first floor, we'll need to warp up to the guardroom with the sniper's window in it.

            Once we're done with the second floor, we need to warp to the roof of building #1, bypassing the elevator. 
            That's always hard because of the building rotation.

            When we're done with that, we'll need to warp to the small island with the maintainer's mark on it.
            From there, we'll need to warp to the center island between the buildings.
            If posible, I'd like for him to build an invisible platform down at lake level so that the guests can take KI photos from down there.

            From there, we'll need to warp to the interior of building #2, into one of the mudrooms. 
            Preferably one on the side that has the maintainer's armor in the dressing room.

            When we get to the dressing room, instead of warping into the wall chamber, I'll enter it by the machine since that works now. 
            All Mirphak will need to do before that is make sure his bot has the lastest PRP. 
            Once I'm in the wall chamber dressed in the armor, we'll just have the guests use the "find larry" command to join me.

            This year, I want to try something new. 
            When we're done in the Wall chamber, we'll need for everyone except me to be warped into the maintainer's nexus outside the little elevator. 
            That way they should be able to watch me linking in and riding up on the elevator.

            For the prison, we'll need to be in the cell to start, and then either warp to the lower level or I can jump down and have everyone "find larry" to join me. 
            Then we'll want to warp up to the ring corridor on the prison cell level to avoid the ladder, and later warp again to the top level to avoid the ladders in the control room.

            And I think that's everything.

            -----------------------------------

            Larry F lun. 22/01/2024 21:47 à Zeke, Susan, moi, Guild

            Yep. 
            Au début du mois, r'Tay et moi avons revu le script pour nous assurer qu'il était à jour.

            Effets nécessaires...

            Une fois que nous serons tous reliés à l'Age, 
            la première chose à faire sera de nous faire traverser le gouffre dans le sol en direction du distributeur de KI.
            Une fois que nous aurons terminé le premier étage, 
            nous devrons nous téléporter jusqu'à la salle de garde avec la fenêtre du tireur d'élite.

            Une fois que nous aurons terminé le deuxième étage, 
            nous devrons nous rendre sur le toit du bâtiment 1, 
            en contournant l'ascenseur. 
            C'est toujours difficile à cause de la rotation des bâtiments.

            Une fois que nous aurons terminé, 
            nous devrons nous rendre sur la petite île portant la marque du mainteneur.
            De là, nous devrons nous rendre sur l'île centrale entre les bâtiments.
            Si possible, j'aimerais qu'il construise une plateforme invisible au niveau du lac 
            pour que les invités puissent prendre des photos du KI depuis cet endroit.

            De là, nous devrons nous rendre à l'intérieur du bâtiment n°2, dans l'un des vestibules. 
            De préférence du côté où se trouve l'armure du mainteneur dans le vestiaire.

            Quand nous arriverons à la loge, au lieu de passer par la pièce du mur, 
            j'entrerai par la machine, puisque cela fonctionne maintenant. 
            Mirphak n'aura plus qu'à s'assurer que son robot a le dernier PRP. 
            Une fois que j'aurai revêtu l'armure dans la pièce du mur, 
            les invités n'auront plus qu'à utiliser la commande "find larry" pour me rejoindre.

            Cette année, je veux essayer quelque chose de nouveau. 
            Quand nous aurons terminé dans la pièce du mur, il faudra que tout le monde, sauf moi, 
            soit transféré dans le nexus du mainteneur, à l'extérieur du petit ascenseur. 
            De cette façon, ils pourront me voir me connecter et monter dans l'ascenseur.

            Pour la prison, nous devrons être dans la cellule pour commencer, 
            puis soit nous nous téléporterons au niveau inférieur, 
            soit je sauterai en bas et je demanderai à tout le monde de "trouver Larry" pour me rejoindre. 
            Ensuite, 
            nous devrons nous diriger vers le couloir de l'anneau au niveau de la cellule de la prison 
            pour éviter l'échelle, et plus tard, 
            nous devrons nous diriger à nouveau vers le niveau supérieur pour éviter les échelles 
            dans la salle de contrôle.

            Et je pense que c'est tout.

            ---------------
            - Preparation -
            ---------------
                - 1 - Arrivee normale : !to gahreesen (= !sp 0)
                    !check noladder
                    import xRobot.xGahreesen as g
                    //nopanic
                    
                    !warpall
                    
                    Gar I, 2nd floor = //ws 1 ct + !warpall ou g.wa(1)
                    Petite ile avec marque des mainteneurs = //ws 2 ct
                    Petite ile entre les 2 immeubles = !sp 8 (ou !sp 7 contre l'etoffe) + !warpall ou g.wa(3)
                    Vestibule / mudroom = !sp 15 (ce n'est pas celle que Larry veut) + !warpall ou g.wa(4)
                    Vestibule côté pièce avec armure mainteneur = //ws 4 ct
                    Pièce avec armure = !sp 16
                    
                    Prison = !sp 19 (ou !sp 18) + !warpall ou g.wa(5)
                    Prison os 1 = //ws 10 ct
                    Prison os 2 = //ws 11 ct
                    Prison bas echelle = //ws 12 ct
                    Prison haut echelle = //ws 13 ct
                    Prison haut devant salle = //ws 14 ct = !sp 20
                    Prison haut centre salle = //ws 15 ct
                    Veranda centre = //ws 16 ct (véranda étoffe = !sp 21; véranda !sp 22)
                    
                    Chambre observation mur avec étoffe = !sp 23 ou !sp 24
                    Chambre observation mur sans étoffe = !sp 25
                    Equipe 1 = !sp 26 ou !sp 35
                    Equipe 2 = !sp 27 ou !sp 28
                    Nexus 1 = !sp 29
                    Nexus 2 = !sp 30
                    Gar I sommet bout avancée = !sp 31 ou !sp 33 (/!\ !sp 32 c'est casse gueule)
                    (on peut faire des bonds entre !sp 8 et !sp 31 ou 33
                    Gar I sommet centre = !sp 34 (peut être utilisé depuis le bas de gar I, mais pas dans l'autre sens)
                    
                    Mur centre salle = //ws 17 ct + !warpall ou g.wa(6)
                - 2 - 
                - 3 - 
                - 4 - 
                - 5 - 

    Version 5 : 24/02/2024
        I did recall something to that effect coming up next weekend. 
        I'm thinking about where I'd like to start. 
        I was thinking it should be in the mudroom outside the training room on the yellow side. 
        I think that's the trianing room that connects to the locker room that has 
        the Maintainer armor hanging in one of the niches. 
        I'll have to check to be sure.

        Oh yeah, before I forget again, 
        it occurred to me that Mirphak will need to do some setup first. 
        I wanted to try to demonstrate the dressing machine in the locker room, and for that, 
        I think he needs to set up the wall on both sides of the building to make 
        the dressing machines active. 
        Unless he can figure out a command to do that, anyway.

        Once I've used the machine to drop into the wall chamber, 
        I'd like to have another of us wait until everyone has been warped to the Wall 
        and then use the machine to follow us in. 
        I don't know what if anything it looks like to see another person appear 
        in the room from the machine, and this is as good an opportunity as any to find out.

        Other than those notes, everything else should be the same as my last message.
        
        We were trying to set up a photo op platform. 
        I didn't mention that because in the end, it's not all that important.
        But we can try it again if you think we should.
        
        I like getting shots upward from the water surface because it shows just 
        how big Gahreesen II really is, but there's a really pesky panic link zone 
        that gives Mirphak no end of trouble when he tries to set up a platform down there 
        and warp everyone to it.
        
        Yeah, it’s the yellow side that has the suit on display. 
        So we’ll want to start in the mudroom outside the training room on that side. 
        As a reminder, 
        the training room is the middle one with the Wall control seat at the end of it.
        
        ---
        
        Je me souviens d'un événement à cet effet qui aura lieu le week-end prochain. 
        Je réfléchis à l'endroit où je voudrais commencer. 
        Je pensais que ce serait dans le vestiaire à l'extérieur de la salle d'entraînement, 
        du côté jaune. 
        Je pense que c'est la salle d'entraînement qui est reliée au vestiaire 
        où se trouve l'armure du mainteneur. 
        l'armure Maintainer suspendue dans l'une des niches. 
        Il faudra que je vérifie pour être sûr.

        Ah oui, avant que je n'oublie à nouveau, 
        il m'est venu à l'esprit que Mirphak devra d'abord s'occuper de l'installation. 
        Je voulais essayer de faire une démonstration de la machine à habiller dans les vestiaires, 
        et pour cela, je pense qu'il doit installer la machine à habiller, 
        je pense qu'il doit installer le mur des deux côtés du bâtiment pour rendre 
        pour que les machines à habiller soient actives. 
        À moins qu'il ne trouve une commande pour le faire, en tout cas.

        Une fois que j'ai utilisé la machine pour descendre dans la chambre murale, 
        j'aimerais qu'un autre d'entre nous attende que tout le monde ait été téléporté au Mur 
        et utiliser la machine pour nous suivre à l'intérieur. 
        Je ne sais pas à quoi ça ressemble de voir une autre personne apparaître 
        dans la pièce à partir de la machine. 
        dans la pièce à partir de la machine, et c'est l'occasion ou jamais de le découvrir.

        À part ces notes, tout le reste devrait être identique à mon dernier message.
        
        Nous essayions de mettre en place une plateforme de photos. 
        Je n'en ai pas parlé parce qu'en fin de compte, ce n'est pas si important.
        Mais nous pouvons réessayer si vous le souhaitez.
        
        J'aime bien prendre des photos à partir de la surface de l'eau, 
        car cela montre à quel point le Gahreesen II est grand. 
        Gahreesen II est vraiment grand, mais il y a une zone de panique très ennuyeuse 
        qui donne du fil à retordre à Mirphak. 
        qui donne du fil à retordre à Mirphak lorsqu'il essaie d'installer une plateforme en bas 
        et d'y téléporter tout le monde.
        
        Oui, c'est du côté jaune que la combinaison est exposée. 
        Nous devrons donc commencer par la salle d'entraînement de ce côté. 
        Pour rappel, 
        la salle d'entraînement est celle du milieu avec le siège de contrôle du mur au bout.
        
"""

from Plasma import *
import math

"""
            pages += ["grsnWellOccluders","grsnWellSecondFloorRooms","grsnWellSecondFloorGearRoom","grsnElevator","grsnExterior"]
            pages += ["grsnVeranda","grsnVerandaExterior","grsnObsRoom01Imager","grsnObsRoom02Imager","grsnPrison","grsnPrisonTunnels"]
            pages += ["grsnTeamRoom01","grsnTeamRoom02","grsnTrainingCenterHalls","grsnTrainingCenterMudRooms","grsnTrainingCntrLinkRm"]
            pages += ["TrnCtrControlRoom01","TrnCtrControlRoom02","trainingCenterObservationRooms","NexusBlackRoom","NexusWhiteRoom"]
            pages += ["WallRoom","grsnWallRoomClimbingPhys"]
            pages += ["FemaleElevatorArrivingBottom","FemaleElevatorArrivingTop","FemaleElevatorLeavingBottom","FemaleElevatorLeavingTop"]
            pages += ["FemaleLandingRoll","FemaleReadyIdle","FemaleReadyJump","FemaleTubeFall"]
            pages += ["FemaleWallClimbDismountDown","FemaleWallClimbDismountLeft","FemaleWallClimbDismountRight","FemaleWallClimbDismountUp"]
            pages += ["FemaleWallClimbDown","FemaleWallClimbFallOff","FemaleWallClimbIdle","FemaleWallClimbLeft"]
            pages += ["FemaleWallClimbMountDown","FemaleWallClimbMountLeft","FemaleWallClimbMountRight","FemaleWallClimbMountUp"]
            pages += ["FemaleWallClimbRelease","FemaleWallClimbRight","FemaleWallClimbUp"]
            pages += ["MaleElevatorArrivingBottom","MaleElevatorArrivingTop","MaleElevatorLeavingBottom","MaleElevatorLeavingTop"]
            pages += ["MaleLandingRoll","MaleReadyIdle","MaleReadyJump","MaleTubeFall"]
            pages += ["MaleWallClimbDismountDown","MaleWallClimbDismountLeft","MaleWallClimbDismountRight","MaleWallClimbDismountUp"]
            pages += ["MaleWallClimbDown","MaleWallClimbFallOff","MaleWallClimbIdle","MaleWallClimbLeft"]
            pages += ["MaleWallClimbMountDown","MaleWallClimbMountLeft","MaleWallClimbMountRight","MaleWallClimbMountUp"]
            pages += ["MaleWallClimbRelease","MaleWallClimbRight","MaleWallClimbUp"]
"""

"""
#
def Play(player, animName, nbTimes):
    try :
        repet = int(nbTimes)
    except ValueError:
        repet = 0
    objKey = PtGetAvatarKeyFromClientID(player.getPlayerID())
    avatar = objKey.getSceneObject().avatar
"""

"""
#
def warpall():
    
    subworld = PtFindSceneobject("WellSub", "Garrison")
    #upElevWarpPoint = PtFindSceneobject("UpElevatorWarpPoint", "Garrison")
    topWarpPoint = ptVector3(65, -422, 10088)
    for player in PtGetPlayerList():
        objKey = PtGetAvatarKeyFromClientID(player.getPlayerID())
        soavatar = objKey.getSceneObject()
        soavatar.avatar.enterSubWorld(subworld)
        #soavatar.physics.warpObj(upElevWarpPoint.getKey())
        soavatar.physics.warp(topWarpPoint)
    soavatar = PtGetLocalAvatar()
    soavatar.avatar.enterSubWorld(subworld)
    #soavatar.physics.warpObj(upElevWarpPoint.getKey())
    soavatar.physics.warp(topWarpPoint)
"""

"""
#
def LinkAll():
    age = ["Ahnonay", "Ahnonay", "55ce4207-aba9-4f2e-80de-7980a75ac3f2", "Mir-o-Bot", ""]
    #les autre joueurs dans mon age
    for player in PtGetPlayerList():
        #playerID = player.getPlayerID()
        LinkPlayerTo(age, playerID = player.getPlayerID(), spawnPointNumber = None)
    # link myself
    LinkPlayerTo(age, playerID = None, spawnPointNumber = None)
"""

#
dicBot = {
    32319:"Mir-o-Bot", 
    27527:"Magic Bot", 
    71459:"Mimi Bot", 
    #L:"Stone5", 
    64145:"Annabot",
    #L:"SkydiverBot",
    3975:"OHBot",
    24891:"Magic-Treasure",
    26224:"Magic Treasure",
    21190:"Mimi Treasure",
    2332508:"mob",
    }

# Larry LeDeay [KI: 11308]
plSpeakerID = 11308

#
def Cercle(coef=3.0, h=10.0, avCentre=None, bPhys=True):
    maxdist = 5
    matrix  = ptMatrix44()
    if isinstance(avCentre, ptMatrix44):
        matrix = avCentre
    elif avCentre is None:
        avCentre = PtGetLocalAvatar()
        matrix = avCentre.getLocalToWorld()
    
    #agePlayers = GetAllAgePlayers()
    # ne pas tenir compte des robots
    agePlayers = [pl for pl in PtGetPlayerList() if not(pl.getPlayerID() in list(dicBot.keys()))]
    agePlayers.append(PtGetLocalPlayer())
    soAvatarList = [PtGetAvatarKeyFromClientID(player.getPlayerID()).getSceneObject() for player in agePlayers]
    for soavatar in soAvatarList:
        #faire flotter tout le monde
        soavatar.netForce(1)
        soavatar.physics.disable()
        soavatar.physics.enable(0)
        soavatar.netForce(1)

    i = 0
    n = len(agePlayers)
    print("nb de joueurs: %s" % (n))
    dist = float(coef * n) / (2.0 * math.pi)
    print("distance: %s" % (dist))
    nbCercles = dist // maxdist
    if nbCercles > 0:
        dist = dist / nbCercles
    """
    for i in range(n):
        player = agePlayers[i]
        avatar = PtGetAvatarKeyFromClientID(player.getPlayerID()).getSceneObject()
        angle = (float(i%maxdist) * float(nbCercles) * 2.0 * math.pi) / float(n)
        dist = dist + (n // maxdist)
        print "angle(%s): %s" % (i, angle)
        dx = float(dist)*math.cos(angle)
        dy = float(dist)*math.sin(angle)
        #matrix = avCentre.getLocalToWorld()
        matrix.translate(ptVector3(dx, dy, float(h)))
        mRot = ptMatrix44()
        mRot.rotate(2, angle - math.pi)
        avatar.netForce(1)
        avatar.physics.enable(bPhys)
        avatar.physics.warp(matrix * mRot)
    """
    for i in range(n):
        avatar = soAvatarList[i]
        angle = (float(i%maxdist) * float(nbCercles) * 2.0 * math.pi) / float(n)
        dist = dist + (n // maxdist)
        print("angle(%s): %s" % (i, angle))
        dx = float(dist)*math.cos(angle)
        dy = float(dist)*math.sin(angle)
        #matrix = avCentre.getLocalToWorld()
        matrix.translate(ptVector3(dx, dy, float(h)))
        mRot = ptMatrix44()
        mRot.rotate(2, angle - math.pi)
        avatar.netForce(1)
        avatar.physics.warp(matrix * mRot)
    for soavatar in soAvatarList:
        #reactiver la physique pour tous
        #if n != 8:
        soavatar.netForce(1)
        soavatar.physics.enable(bPhys)


"""    Pour aller sur le toit de la 1ere tour: wa(3) + wa(8) + wa(9)
    "0": Point d'arrivee dans l'age
    "1": Salle scarabee 2e etage
    #"2": Devant ascenseur montant
    "2": Salle des machines
    "3": Exterieur, ile centrale
    "4": Interieur, entree tour entrainement
    "5": Cellule prison
    "6": Salle du mur
    "7": Nexus mur
    "8": Intermediaire pour monter sur le toit
    "9": Toit exterieur
    "10": Cellule Prison
    "11": Sous cellule prison
    "12": Prison, squelette 1
    "13": Prison, squelette 2
    "14": Prison echelle bas
    "15": Prison echelle inter
    "16": Prison centre salle echelles bas
    "17": Veranda centre echelles haut
"""
def wa(n=0, bCircle=False, bSpeaker=False):
    # les points de warp
    ws = { 
        #"0": ((0.986239790916, 0.165321528912, 0.0, 92.0742950439), (-0.165321528912, 0.986239790916, 0.0, -421.575561523), (0.0, 0.0, 1.0, 10087.4404297), (0.0, 0.0, 0.0, 1.0)), 
        "0": ((0.999802947044, -0.0198498461396, 0.0, 76.9855041504), (0.0198498461396, 0.999802947044, 0.0, -486.937957764), (0.0, 0.0, 1.0, -278.870513916), (0.0, 0.0, 0.0, 1.0)), 
        "1": ((-0.99768871069, 0.0679508671165, 0.0, 95.7189483643), (-0.0679508671165, -0.99768871069, 0.0, -449.018035889), (0.0, 0.0, 1.0, -250.387756348), (0.0, 0.0, 0.0, 1.0)), 
        #"2": ((-0.794308185577, 0.607515096664, 0.0, 31.8062763214), (-0.607515096664, -0.794308185577, 0.0, -426.600250244), (0.0, 0.0, 1.0, -279.017913818), (0.0, 0.0, 0.0, 1.0)), 
        "2": ((-0.802598953247, -0.596519052982, 0.0, 23.788734436), (0.596519052982, -0.802598953247, 0.0, -508.485046387), (0.0, 0.0, 1.0, -250.534179688), (0.0, 0.0, 0.0, 1.0)), 
        "3": ((0.985827445984, -0.167762547731, 0.0, 73.2108154297), (0.167762547731, 0.985827445984, 0.0, -267.512207031), (0.0, 0.0, 1.0, 10085.6845703), (0.0, 0.0, 0.0, 1.0)), 
        "4": ((0.451631933451, 0.892204344273, 0.0, 211.293777466), (-0.892204344273, 0.451631933451, 0.0, 297.770355225), (0.0, 0.0, 1.0, -9.74115753174), (0.0, 0.0, 0.0, 1.0)), 
        "5": ((-0.997065663338, -0.0765519589186, 0.0, 72.6664428711), (0.0765519589186, -0.997065663338, 0.0, 439.641204834), (0.0, 0.0, 1.0, 965.71081543), (0.0, 0.0, 0.0, 1.0)), 
        "6": ((-0.490352004766, 0.871524512768, 0.0, 0.0407438091934), (-0.871524512768, -0.490352004766, 0.0, 134.997406006), (0.0, 0.0, 1.0, -30.0120010376), (0.0, 0.0, 0.0, 1.0)), 
        "7": ((-0.0984519198537, 0.995141744614, 0.0, -376.244354248), (-0.995141744614, -0.0984519198537, -0.0, -6.76931190491), (-0.0, 0.0, 1.0, -0.022900916636), (0.0, 0.0, 0.0, 1.0)), 
        "8": ((-0.999864518642, 0.0164644680917, 0.0, 76.7055206299), (-0.0164644680917, -0.999864518642, 0.0, -289.055328369), (0.0, 0.0, 1.0, 10086.1855469), (0.0, 0.0, 0.0, 1.0)), 
        "9": ((-0.951500952244, -0.307654172182, 0.0, 33.7776107788), (0.307654172182, -0.951500952244, 0.0, -458.413269043), (0.0, 0.0, 1.0, 10087.4404297), (0.0, 0.0, 0.0, 1.0)), 
        "10": ((-1.34358856485e-07, -1.00000011921, 0.0, 72.1411972046), (1.00000011921, -1.34358856485e-07, 0.0, 443.795959473), (0.0, 0.0, 1.0, 965.71081543), (0.0, 0.0, 0.0, 1.0)), 
        "11": ((-0.695429027081, -0.718594908714, 0.0, 74.3801956177), (0.718594908714, -0.695429027081, 0.0, 448.348876953), (0.0, 0.0, 1.0, 955.553771973), (0.0, 0.0, 0.0, 1.0)), 
        "12": ((-0.783920109272, 0.620861828327, 0.0, -6.6934876442), (-0.620861828327, -0.783920109272, 0.0, 490.109649658), (0.0, 0.0, 1.0, 955.553710938), (0.0, 0.0, 0.0, 1.0)), 
        "13": ((-0.883565783501, -0.468307256699, 0.0, 151.240356445), (0.468307256699, -0.883565783501, 0.0, 497.088775635), (0.0, 0.0, 1.0, 955.553710938), (0.0, 0.0, 0.0, 1.0)), 
        "14": ((0.541787862778, 0.840515255928, 0.0, 114.343582153), (-0.840515255928, 0.541787862778, 0.0, 559.231994629), (0.0, 0.0, 1.0, 955.553710938), (0.0, 0.0, 0.0, 1.0)), 
        "15": ((-0.886784672737, 0.462182939053, 0.0, 119.639907837), (-0.462182939053, -0.886784672737, 0.0, 549.495178223), (0.0, 0.0, 1.0, 965.579162598), (0.0, 0.0, 0.0, 1.0)), 
        "16": ((0.999342978001, -0.0362437516451, 0.0, 71.1204833984), (0.0362437516451, 0.999342978001, 0.0, 530.367980957), (0.0, 0.0, 1.0, 965.72277832), (0.0, 0.0, 0.0, 1.0)), 
        "17": ((0.999342978001, -0.0362437516451, 0.0, 71.1204833984), (0.0362437516451, 0.999342978001, 0.0, 530.367980957), (0.0, 0.0, 1.0, 993.55480957), (0.0, 0.0, 0.0, 1.0)), 
        }
    #desactiver les zones de panique
    #DisablePanicLinks()
    
    mat = ptMatrix44()
    mat.setData(ws[str(n)])
    
    if bCircle:
        Cercle(coef=2.0, h=10.0, avCentre=mat, bPhys=True)
    else:
        #recuperer tous les joueurs
        playerList = PtGetPlayerList()
        playerList.append(PtGetLocalPlayer())
        if bSpeaker:
            playerList = [p for p in playerList if p.getPlayerID() != plSpeakerID]
        
        """
        for player in playerList:
            objKey = PtGetAvatarKeyFromClientID(player.getPlayerID())
            soavatar = objKey.getSceneObject()
            
            #faire flotter tout le monde
            soavatar.physics.enable(0)
            soavatar.netForce(1)
            
            #deplacer les gens
            soavatar.physics.warp(mat)
            soavatar.netForce(1)
            
            #reactiver la physique pour tous
            if n != 8:
                soavatar.physics.enable(1)
                soavatar.netForce(1)
        """
        soAvatarList = [PtGetAvatarKeyFromClientID(player.getPlayerID()).getSceneObject() for player in playerList]
        for soavatar in soAvatarList:
            #faire flotter tout le monde
            soavatar.netForce(1)
            soavatar.physics.disable()
            soavatar.physics.enable(0)
            soavatar.netForce(1)
        for soavatar in soAvatarList:
            #deplacer les gens
            soavatar.physics.warp(mat)
            soavatar.netForce(1)
        for soavatar in soAvatarList:
            #reactiver la physique pour tous
            if n != 8:
                soavatar.physics.enable(1)
                soavatar.netForce(1)

# Find scene objects with name like soName in all loaded districts (aka pages or prp files)
# ex.: soName = "Bahro*Stone" will be transformed in regexp "^.*Bahro.*Stone.*$"
def FindSOName(soName):
    import re
    cond = "^.*" + soName.replace("*", ".*") + ".*$"
    try:
        pattern = re.compile(cond, re.IGNORECASE)
    except:
        return list()
    strList = soName.split("*")
    nameList = list()
    for str in strList:
        nameList.extend([so.getName() for so in PtFindSceneobjects(str)])
    nameList = list(set(nameList))
    nameList = [x for x in nameList if pattern.match(x) != None]
    return nameList

# Find scene objects with name like soName in all loaded districts (Warning, it includes GUI)
def FindSOLike(soName):
    nameList = FindSOName(soName)
    soList = list()
    for soName in nameList:
        sol = PtFindSceneobjects(soName)
        soList.extend(sol)
    return soList

# Remove the panic regions, I assume that all the panic links contain "Panic" or "panic" in there names.
def DisablePanicLinks():
    sol = FindSOLike("anic")
    for so in sol:
        so.netForce(1)
        so.physics.disable()

#
def panic():
    PtConsoleNet("Avatar.Spawn.DontPanic" , 1)

#
def RemoveLadder():
    ''' Stop people from climbing the ladder. '''
    for i in range(1, 3):
        p = PtFindSceneobject('LadderUpOn POS%02d' % i, 'Garrison').physics
        p.netForce(1)
        p.enable(0)

#
def AddPrp():
    ''' Add Gahreesen Wall pages '''
    #global bWallAdded
    pages = ["WallRoom","grsnWallRoomClimbingPhys"]
    for page in pages:
        PtConsoleNet("Nav.PageInNode %s" % (page) , 1)
    #bWallAdded = True

#
def nowall():
    ''' Unload Gahreesen Wall climbing pages '''
    #global bWallAdded
    pages = []
    pages += ["FemaleWallClimbDismountDown","FemaleWallClimbDismountLeft","FemaleWallClimbDismountRight","FemaleWallClimbDismountUp"]
    pages += ["FemaleWallClimbDown","FemaleWallClimbFallOff","FemaleWallClimbIdle","FemaleWallClimbLeft"]
    pages += ["FemaleWallClimbMountDown","FemaleWallClimbMountLeft","FemaleWallClimbMountRight","FemaleWallClimbMountUp"]
    pages += ["FemaleWallClimbRelease","FemaleWallClimbRight","FemaleWallClimbUp"]
    pages += ["MaleWallClimbDismountDown","MaleWallClimbDismountLeft","MaleWallClimbDismountRight","MaleWallClimbDismountUp"]
    pages += ["MaleWallClimbDown","MaleWallClimbFallOff","MaleWallClimbIdle","MaleWallClimbLeft"]
    pages += ["MaleWallClimbMountDown","MaleWallClimbMountLeft","MaleWallClimbMountRight","MaleWallClimbMountUp"]
    pages += ["MaleWallClimbRelease","MaleWallClimbRight","MaleWallClimbUp"]
    for page in pages:
        PtConsoleNet("Nav.PageOutNode %s" % (page) , 1)
    #bWallAdded = False

# =====================================================================
#
def LinkPlayerTo(age, playerID=None, spawnPointNumber=None):
    if not playerID or playerID == "":
        playerID = PtGetLocalPlayer().getPlayerID()
    else:
        try:
            playerID = int(playerID)
        except:
            return "incorrect playerID"
            #pass
    if len(age) < 3:
        #pass
        return "incorrect age"
    ageInstanceName = age[0]
    ageFileName = age[1]
    ageGuid = age[2]
    ageUserDefinedName = ""
    if len(age) > 3:
        ageUserDefinedName = age[3]
    
    ageLink = ptAgeLinkStruct()
    ageInfo = ptAgeInfoStruct()
    ageInfo.setAgeFilename(ageFileName)
    ageInfo.setAgeInstanceGuid(ageGuid)
    ageInfo.setAgeInstanceName(ageInstanceName)
    
    ageLink.setAgeInfo(ageInfo)
    
    # Debut gestion du spawn point
    spawnPt = "LinkInPointDefault"
    if spawnPointNumber:
        spawnPt = GetSpawnPoint(spawnPointNumber)
    else:
        ageSpawPoint = ""
        if len(age) > 4:
            ageSpawPoint = age[4]
        if ageSpawPoint != "":
            spawnPt = ageSpawPoint
    #PtSendKIMessage(kKILocalChatStatusMsg, "sp=\""+spawnPt+"\"")
    spawnPoint = ptSpawnPointInfo()
    spawnPoint.setName(spawnPt)
    ageLink.setSpawnPoint(spawnPoint)
    # Fin gestion du spawn point
    
    ptNetLinkingMgr().linkPlayerToAge(ageLink, playerID)
    return ageUserDefinedName + " " + ageInstanceName

#
playerIdList = []

#
def SavePlayers():
    global playerIdList
    agePlayers = [pl for pl in PtGetPlayerList() if not(pl.getPlayerID() in list(dicBot.keys()))]
    agePlayers.append(PtGetLocalPlayer())
    playerIdList = [player.getPlayerID() for player in agePlayers]

"""
    "aegura":["city", "city", "9511bed4-d2cb-40a6-9983-6025cdb68d8b", "Mir-o-Bot's", "LinkInPointBahro-PalaceBalcony"],
    "relto":["Relto", "Personal", "6e7a66cc-e0c1-4efc-977a-cd7a354a736a", "Mir-o-Bot's", "LinkInPointBahroPoles"], 
    "Office":["Ae'gura", "BaronCityOffice", "2aaf334b-a49e-40f2-963b-5be146d40021", "Mir-o-Bot's Office", ""],
    "spyroom":["spyroom", "spyroom", "df9d49ec-0b9c-4716-9a0f-a1b66f7d9814", "mob's (Sharper's spy room)", ""],
    "phil":["philRelto", "philRelto", "e8a2aaed-5cab-40b6-97f3-6d19dd92a71f", "philRelto", ""],
"""

#
def LinkAll(ageName):
    if ageName == "spy":
        age = ["spyroom", "spyroom", "df9d49ec-0b9c-4716-9a0f-a1b66f7d9814", "mob's (Sharper's spy room)", ""]
    elif ageName == "gahreesen":
        age = ["Gahreesen", "Garrison", "42f261ba-b74e-45a3-afb8-0bda76f44b34", "Mir-o-Bot's", ""]
    elif ageName == "prison":
        age = ["Gahreesen", "Garrison", "42f261ba-b74e-45a3-afb8-0bda76f44b34", "Mir-o-Bot's", "LinkInPointPrison"]
    elif ageName == "veranda":
        age = ["Gahreesen", "Garrison", "42f261ba-b74e-45a3-afb8-0bda76f44b34", "Mir-o-Bot's", "PlayerStart"]

    #les autre joueurs dans mon age
    for player in PtGetPlayerList():
        #playerID = player.getPlayerID()
        LinkPlayerTo(age, playerID = player.getPlayerID(), spawnPointNumber = None)
    # link myself
    LinkPlayerTo(age, playerID = None, spawnPointNumber = None)

# Link all saved players in choosen age
def la(ageName):
    global playerIdList
    if ageName == "spy":
        age = ["spyroom", "spyroom", "df9d49ec-0b9c-4716-9a0f-a1b66f7d9814", "mob's (Sharper's spy room)", ""]
    elif ageName == "gahreesen":
        age = ["Gahreesen", "Garrison", "42f261ba-b74e-45a3-afb8-0bda76f44b34", "Mir-o-Bot's", ""]
    elif ageName == "prison":
        age = ["Gahreesen", "Garrison", "42f261ba-b74e-45a3-afb8-0bda76f44b34", "Mir-o-Bot's", "LinkInPointPrison"]
    elif ageName == "veranda":
        age = ["Gahreesen", "Garrison", "42f261ba-b74e-45a3-afb8-0bda76f44b34", "Mir-o-Bot's", "PlayerStart"]

    # Lier les joueurs connus dans l'age choisi
    for playerId in playerIdList:
        LinkPlayerTo(age, playerID=playerId, spawnPointNumber=None)

# Set SDL Wall State to 4
def wall(state=4):
    ageSDL = PtGetAgeSDL()
    ageSDL["nState"] = (state,)
    ageSDL["sState"] = (state,)
